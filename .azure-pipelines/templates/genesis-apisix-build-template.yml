parameters:
  - name: CONTAINER_NAME
    type: string
  - name: DOCKERFILE_PATH
    type: string
  - name: AZURE_CONTAINER_REGISTRY
    type: string
  - name: BUILD_ARGS
    type: string
    default: ''
  - name: jobCondition
    type: string
    default: succeeded()

jobs:
- job: BuildAndPushGenesisAPISIX
  displayName: 'Build and Push Genesis APISIX'
  condition: ${{ parameters.jobCondition }}
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    submodules: true
    persistCredentials: true

  - task: Docker@2
    displayName: 'Build Genesis APISIX Image'
    inputs:
      command: 'build'
      repository: '${{ parameters.CONTAINER_NAME }}'
      containerRegistry: '${{ parameters.AZURE_CONTAINER_REGISTRY }}'
      dockerfile: '${{ parameters.DOCKERFILE_PATH }}'
      buildContext: '.'
      ${{ if ne(parameters.BUILD_ARGS, '') }}:
        arguments: '${{ parameters.BUILD_ARGS }}'
      tags: |
        $(Build.BuildNumber)
        latest
    condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

  - script: |
      set -e
      IMAGE_FULL="$(ACR_ENDPOINT)/${{ parameters.CONTAINER_NAME }}:$(Build.BuildNumber)"
      echo "Built image: $IMAGE_FULL"
      docker images
      echo "Verifying APISIX version..."
      docker run --rm "$IMAGE_FULL" apisix version
    displayName: 'Verify APISIX Build'

  - script: |
      set -e
      IMAGE_FULL="$(ACR_ENDPOINT)/${{ parameters.CONTAINER_NAME }}:$(Build.BuildNumber)"
      
      echo "===== Running Final Dependency Validation ====="
      echo "Checking for missing runtime libraries (e.g., libpcre.so.1)"
      
      chmod +x ./ci/validate-docker-image.sh
      export VALIDATION_TIMEOUT=60
      
      if ./ci/validate-docker-image.sh "$IMAGE_FULL"; then
        echo "âœ“ Final validation passed - image is ready for deployment"
      else
        echo "ERROR: Built image failed validation"
        echo "This image has missing dependencies and should not be deployed!"
        exit 1
      fi
    displayName: 'Validate Built Image Dependencies'

  - script: |
      set -e
      IMAGE_FULL="$(ACR_ENDPOINT)/${{ parameters.CONTAINER_NAME }}:$(Build.BuildNumber)"
      echo "Installing Trivy for final verification..."
      curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
      trivy --version
      
      echo "Scanning built image: $IMAGE_FULL"
      trivy image --scanners vuln --severity CRITICAL,HIGH --pkg-types os --format json "$IMAGE_FULL" > trivy-report.json
      
      echo "Vulnerability Summary:"
      cat trivy-report.json | jq '{CRITICAL: (.Results[0].Vulnerabilities // [] | map(select(.Severity == "CRITICAL")) | length), HIGH: (.Results[0].Vulnerabilities // [] | map(select(.Severity == "HIGH")) | length)}'
    displayName: 'Security Scan Built Image'

  - task: Docker@2
    displayName: 'Push Genesis APISIX Image'
    inputs:
      command: 'push'
      repository: '${{ parameters.CONTAINER_NAME }}'
      containerRegistry: '${{ parameters.AZURE_CONTAINER_REGISTRY }}'
      tags: |
        $(Build.BuildNumber)
        latest
    condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

  - script: |
      git tag apisix-$(Build.BuildNumber)
      git push origin apisix-$(Build.BuildNumber)
    displayName: 'Git Tag'
    condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

  - script: |
      echo "Genesis APISIX image built and pushed successfully"
      echo "Image: $(ACR_ENDPOINT)/${{ parameters.CONTAINER_NAME }}:$(Build.BuildNumber)"
      echo "Components:"
      echo "  - Apache APISIX 3.15.0"
      echo "  - OpenResty 1.27.1.2"
      echo "  - Base: OpenResty Alpine-Fat (Alpine 3.22.3)"
      echo "  - Runtime utilities: curl, wget, jq, bind-tools, ca-certificates"
      echo "  - Security: 0 CRITICAL/HIGH CVEs (Alpine-based hardened image)"
    displayName: 'Genesis APISIX Build Summary'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Trivy Report'
    inputs:
      PathtoPublish: 'trivy-report.json'
      ArtifactName: 'security-scan'
    condition: and(succeededOrFailed(), eq(variables['Agent.JobStatus'], 'Succeeded'))

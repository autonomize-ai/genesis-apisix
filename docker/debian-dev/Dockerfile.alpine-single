#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# ---------------------------------------------------------------------------
# CVE Hardening: Migrated from debian:bullseye-slim to Alpine-based OpenResty.
# debian:bullseye-slim: 2 CRITICAL + 7 HIGH CVEs (will_not_fix/affected)
# openresty/openresty:alpine-fat: 0 HIGH/CRITICAL CVEs
#
# Note: Using single-stage alpine-fat (vs multi-stage alpine+alpine-fat)
# to avoid Docker multi-stage parallelism issues with apk symbol resolution.
# ---------------------------------------------------------------------------

FROM openresty/openresty:alpine-fat

ARG ENABLE_PROXY=false
ARG CODE_PATH
ARG ENTRYPOINT_PATH=./docker-entrypoint.sh
ARG INSTALL_BROTLI=./install-brotli.sh

ENV ENV_INST_LUADIR=/usr/local/apisix
ENV ENV_OPENSSL_PREFIX=/usr/local/openresty/openssl3
ENV ENV_LUAROCKS=/usr/local/openresty/luajit/bin/luarocks

# Install dependencies (build-time + runtime)
RUN apk add --no-cache \
        make \
        git \
        yaml-dev \
        yaml \
        gcc \
        musl-dev \
        linux-headers \
        curl \
        unzip \
        gawk \
        pcre-dev \
        pcre2-dev \
        openldap-dev \
        bash

COPY ${CODE_PATH} /apisix
WORKDIR /apisix

# Install LuaRocks dependencies + APISIX
RUN set -x \
    && ls -al \
    && mkdir -p ~/.luarocks \
    && ${ENV_LUAROCKS} config variables.OPENSSL_LIBDIR ${ENV_OPENSSL_PREFIX}/lib \
    && ${ENV_LUAROCKS} config variables.OPENSSL_INCDIR ${ENV_OPENSSL_PREFIX}/include \
    && ${ENV_LUAROCKS} config variables.YAML_DIR /usr \
    && ${ENV_LUAROCKS} install apisix-master-0.rockspec --tree deps --only-deps \
    && mkdir -p ${ENV_INST_LUADIR} \
    && cp -r deps ${ENV_INST_LUADIR} \
    && ENV_NGINX_EXEC=/usr/local/openresty/bin/openresty make install \
    && mkdir -p /usr/local/apisix/ui

# Install brotli (skipped - apk symbol resolution issues; not critical for APISIX core)
# COPY ${INSTALL_BROTLI} /tmp/install-brotli.sh
# RUN chmod +x /tmp/install-brotli.sh \
#     && cd /tmp && ./install-brotli.sh && rm -f /tmp/install-brotli.sh

# Clean up build dependencies to reduce image size
RUN apk del make git gcc musl-dev linux-headers unzip gawk pcre-dev pcre2-dev curl

# Set permissions
RUN chgrp -R 0 /usr/local/apisix \
    && chmod -R g=u /usr/local/apisix

ENV PATH=$PATH:/usr/local/openresty/luajit/bin:/usr/local/openresty/nginx/sbin:/usr/local/openresty/bin

WORKDIR /usr/local/apisix

RUN ln -sf /dev/stdout /usr/local/apisix/logs/access.log \
    && ln -sf /dev/stderr /usr/local/apisix/logs/error.log

EXPOSE 9080 9443

COPY ${ENTRYPOINT_PATH} /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["docker-start"]

STOPSIGNAL SIGQUIT
